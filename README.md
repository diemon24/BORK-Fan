# Интегрируем Вентилятор BORK в ESPHome
Модернизация вентилятора BORK CF TOR4135 BK для ESPHome
![image](https://github.com/user-attachments/assets/f24ba285-db0f-4c65-ab9d-7a27ca6564b9)


Перед тем как модернизировать вентилятор я ставил перед собой задачу не только оставить текущий функционал, но и дополнить его - вентилятор должен уметь работать без интеграции с HomeAssistant. Но и сама интеграция с моим умным домом позволит расширить возможности вентилятора. 
Сразу оговорюсь, что я пытался использовать вентилятор через SmartIR, но в практике такое использование обернулось некорректной работой из-за работы функции осцилляции (вращения) - ИК сигналы просто не всегда улавливались из-за того, что вентилятор в момент отправки команды мог быть отвернут от ИК-передатчика. Ну и привязка данного вентилятора к комнате, в которой установлен ИК-передачик такое себе - вентилятор нужно иметь возможность носить в разные комнаты. 
IR коды для управления вентилятором через штатный пульт: https://github.com/smarthomehub/smartir/issues/1227?ysclid=mbj3myt8as96671823

Штатные функции вентилятора при использовании кнопок на панели управления: 
- Вкл/Выкл
- Выбор скорости (3 скорости)
- Режим эффекта природного ветра (волнообразный)
- Таймер выключения (никогда не использовал - считаю самой бесполезной функцией - разработчикам BORK привет)
- Вкл/Выкл осцилляции (вращения вентилятора по своей оси, для распределения воздушного потока в помещении) - приходится включать каждый раз когда включаешь вентиляцию
- Звуковая индикация нажатий 
- Световая индикация, включая 2 кнопки с трехцветной индикацией (выбор скорости, таймер)
- Управление через ИК-пульт

Новый функционал: 
- Вкл/Выкл (один клик), перезагрузка ESP - мультиклик (3 cек)
- Выбор скорости (3 скорости - циркулирующий клик)
- Режим эффекта природного ветра (волнообразный)
- Режим "По температуре" - один клик и двоное нажатие кнопки на панели управления вентилятором выбирает два режима: 1. Вкл/выкл по достижению температуры в помещении 26 и 25 градусов соответственно, 2. Вкл/Выкл по достижению температуры в помещении 27 и 26 градусов соответственно. Более точные настройки можно выполнить в карточке HomeAssistant.  
- Вкл/Выкл осцилляции (вращения вентилятора по своей оси, для распределения воздушного потока в помещении) - вкл/выкл клик сохраняет настройку до выключения питания
- Звуковая индикация нажатий с разными эффектами
- Световая индикация, включая 2 кнопки с трехцветной индикацией (выбор скорости, таймер)
- Управление через ИК-пульт (опционально подключение IR-приемника на GPIO20 - данный GPIO необходимо переключить в режим input без возможности использования USB)
- Звуковая индикация корректной загрузки ESP при подаче питания
- Звуковая и световая индикация при подключении к сети Wi-Fi (в разработке при необходимости)
- Режим "Не беспокоить" - возможность отключения звуковой/световой индикации (в разработке при необходимости)
- Ну и ради чего все это: управляем из HomeAssistant и т.п.

# Модернизация: 

Схема блока управления вентилятором:
![image](https://github.com/user-attachments/assets/7caa9f32-cb5d-4d26-a4d2-1a562989f157)

![image](https://github.com/user-attachments/assets/c03315d1-4681-4d80-b3af-2ef14ed7b021)

![image](https://github.com/user-attachments/assets/6c88ee3e-b056-460a-a6ab-a0d524986c3f)


Gerber файл в https://github.com/diemon24/BORK-Fun/blob/main/Gerber_PCB4_2025-06-05_ver.1.1.zip


**Вам нужно использовать плату разработки ESP32 S3 в узком формате (на 2мм более узкая).** Тем не менее расположить на контроллере можно плату разработки ESP32S3 в широком формате (что я и сделал), но тогда необходимо использовать однорядные гнездовые разъемы для монтажа ESP32S3 на плату с небольлшим их наклоном в стороны. При использовании гнездовых разъемов для монтажа ESP32S3 на плату, высота монтажа ESP32S3 увеличивается и потребуется небольшая доработка задней стенки корпуса - сделав отверстие под размер ESP. Но от этого тоже есть плюс - при необходимости прошивки через JTAG, это можно будет выполнить без демонтажа корпуса вентилятора. :) 

Я выбрал плату ESP32 S3 т.к. она имеет необходимое количество пинов в режиме AЦП. 

![image](https://github.com/user-attachments/assets/352f501e-72cd-472c-95ae-b16fa105c388)
![image](https://github.com/user-attachments/assets/39483251-6d7c-426a-8f76-fde66d64d504)



В качестве датчика температуры выбран датчик ATH30 (https://esphome.io/components/sensor/aht10.html). Если есть необходимость использовать другой датчик (например TVOC и т.п.), то его также можно подключить в разъем CN6 i2c шины с небольшой доработкой прошивки. 

Часть деталей я использовал со штатной платы: зуммер, конденсатор C1 и варистор R1. 


Монтируем компоненты на плату:

![IMG_20250601_235638](https://github.com/user-attachments/assets/60d17455-1080-4cf0-8326-2b443edb218f)


На нижней стороны платы подготовлены места для мотажа RC фильтра (C2-R12, C3-R13, C4-R14, C5-R15), которые (как рекомендуют некоторые непроверенные источники в сети Интернет) необходимы для защиты симистора, и резисторов подтяжки (R16-R19). Но по факту RC и PULL-UP я не использую, т.к. электродвигатели вентилятора не имеют высокой мощности. Заявленная производителем мощность потребления вентилятора - не более 40Вт, когда как используются симисторы с возможностью подключения нагрузки до 1А на канал (±220 Вт). 
Это моя первая разработка платы и схемы в EasyEDA для ESPHome, поэтому не судите строго.  

![image](https://github.com/user-attachments/assets/b7c53e6d-aaeb-4f6d-b2f2-766b18ceb931)


Сравнение нового контроллера со штатной платой:

![IMG_20250602_222543](https://github.com/user-attachments/assets/c2f7fa85-5b4c-4af8-84b5-30729b21337e)


Я не стал проектировать новые платы для кнопок и светодиодов, а использовал штатные вполне подходящие платы. Не смотря на то, что для управления светодиодами используется ШИМ, для порядка на аппаратном уровне я все равно заменил перемычку между светодиодами TYPE и SPEED (выпаял нужный по цветовой схеме с демонтированной штатной платы) и соединил каплей припоя черный провод (GND) с дорожкой, идущей сразу под местом подпайки - дав светодиоду SWING GND подключение. Собственно больше никаких доработок не производилось. 

Если при сборке соблюсти цветовую маркировку проводов при подключении разъемов CN2 и CN3 (как у меня на фото), тогда не потребуется ничего переделывать в YAML файле ESPHome https://github.com/diemon24/BORK-Fun/blob/main/bork_fun.yaml. 

Монтируем плату в корпус, при этом повернув ее USB-C разъемами ESP32-S3 к тыловой стороне вентилятора. 

Перед монтажом обратите внимание на цветовую гамму проводов для управления электродвигателями - это необходимо учесть, чтобы скоростной режим и функция осцилляции функционировали корректно: 
![IMG_20250602_230321](https://github.com/user-attachments/assets/13ba73bd-4081-463e-ab4a-7077d1bca685)

![IMG_20250601_163346](https://github.com/user-attachments/assets/16da0fa4-c632-4a93-97a3-199e8716ec61)

![IMG_20250603_005233](https://github.com/user-attachments/assets/212da8f3-bb88-4db6-b650-5d399ea66ce3)

![IMG_20250603_005219](https://github.com/user-attachments/assets/7bd442f5-815d-4c85-a3a3-369003d707d2)



Монтируем (клеем) датчик температуры на задней стенке вентилятора:
![image](https://github.com/user-attachments/assets/eddfed44-2846-4b64-9e45-79a8532cbf94)



Вот что мы получили в HomeAssistant: 

<img width="799" alt="image" src="https://github.com/user-attachments/assets/31c60f03-009a-48c3-ac83-766e8a5960e7" />


# Благодарности:
Помогал тестировать связку оптопары, давал рекомендации по схеме и плате Владимир @Greg_v_v, за что выражаю ему непомерную благодарность. 


# Используемые материалы:
Про ESP32-S3: https://dzen.ru/a/ZWuGsGuc3zHADD-l?ysclid=mbgftn7cqe275957289
